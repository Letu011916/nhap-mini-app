<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Khám phá Từ trường – Nam châm và Chồng chập</title>
<style>
  :root { --ui: #e8e8e8; --ink: #222; }
  body { font-family: system-ui, sans-serif; margin: 16px; color: var(--ink); }
  #wrap { display: grid; grid-template-columns: 300px 1fr; gap: 12px; align-items: start; }
  fieldset { border: 1px solid #ccc; padding: 10px; border-radius: 8px; }
  legend { font-weight: 700; }
  label { display: block; margin: 6px 0; }
  input[type="range"] { width: 100%; }
  canvas { width: 100%; height: auto; border: 1px solid #ccc; border-radius: 8px; background: white; }
  .btn { padding: 6px 10px; border: 1px solid #bbb; border-radius: 6px; background: #f6f6f6; cursor: pointer; }
  .row { display: flex; gap: 8px; flex-wrap: wrap; }
  small { color:#666; }
</style>
</head>
<body>
<h1>Khám phá Từ trường</h1>
<p>Kéo – thả nam châm, xoay bằng cách kéo chấm tròn ở đầu. Tích chọn để hiển thị mũi tên trường hoặc đường sức. Trỏ chuột để xem “la bàn” tại điểm.</p>
<div id="wrap">
  <fieldset>
    <legend>Điều khiển</legend>
    <label><input type="checkbox" id="showArrows" checked> Hiển thị mũi tên véc‑tơ B (lưới)</label>
    <label><input type="checkbox" id="showStream"> Hiển thị đường sức (từ N → S)</label>
    <label>Độ dày lưới mũi tên
      <input type="range" id="gridStep" min="30" max="90" value="50">
    </label>
    <label>Độ dài mũi tên hiển thị
      <input type="range" id="arrowScale" min="12" max="60" value="26">
    </label>
    <div class="row" style="margin-top:6px;">
      <button class="btn" id="addMagnet">+ Thêm nam châm</button>
      <button class="btn" id="reset">↺ Đặt lại</button>
    </div>
    <hr>
    <b>Mẹo</b>
    <ul>
      <li>Nhấp gần tâm để <i>kéo</i> nam châm.</li>
      <li>Nhấp kéo chấm tròn ở đầu để <i>xoay</i>.</li>
      <li>Giữ <b>Shift</b> khi kéo để xoay theo từng 15°.</li>
    </ul>
  </fieldset>

  <canvas id="cv" width="1000" height="650" aria-label="Mặt phẳng quan sát từ trường"></canvas>
</div>

<script>
const cv = document.getElementById('cv');
const ctx = cv.getContext('2d');
const ui = {
  showArrows: document.getElementById('showArrows'),
  showStream: document.getElementById('showStream'),
  gridStep: document.getElementById('gridStep'),
  arrowScale: document.getElementById('arrowScale'),
  addMagnet: document.getElementById('addMagnet'),
  reset: document.getElementById('reset'),
};

let magnets = [];
const soft = 1800; // hệ số "làm mềm" để tránh kỳ dị tại cực (đơn vị px^3)
const streamSeedsPerMagnet = 18;

function deg(a){ return a*180/Math.PI; }
function rad(a){ return a*Math.PI/180; }

// Khởi tạo 2 nam châm mẫu
function defaultMagnets(){
  magnets = [
    {x: 360, y: 330, angle: 0, strength: 1.0, length: 100},
    {x: 640, y: 330, angle: Math.PI, strength: 1.0, length: 100},
  ];
}
defaultMagnets();

// Tính hai cực ±q của một nam châm (mô hình cực từ)
function poles(m){
  const hx = Math.cos(m.angle)*m.length/2;
  const hy = Math.sin(m.angle)*m.length/2;
  return [
    {x: m.x + hx, y: m.y + hy, q: +m.strength}, // Bắc (N)
    {x: m.x - hx, y: m.y - hy, q: -m.strength}, // Nam (S)
  ];
}

// Tính véc‑tơ B tổng tại (x,y) (chuẩn hoá đơn vị hiển thị)
function B(x,y){
  let bx=0, by=0;
  for(const m of magnets){
    const ps = poles(m);
    for(const p of ps){
      const rx = x - p.x, ry = y - p.y;
      const r2 = rx*rx + ry*ry + 1;
      const r3 = Math.pow(r2 + soft, 1.5);
      const c = p.q / r3;
      bx += c * rx;
      by += c * ry;
    }
  }
  return {bx, by};
}

// Vẽ mũi tên tại (x,y) với véc‑tơ (ux,uy) đã chuẩn hoá độ dài
function arrow(x,y,ux,uy,len){
  const a = Math.atan2(uy,ux);
  const nx = Math.cos(a)*len, ny = Math.sin(a)*len;
  ctx.beginPath();
  ctx.moveTo(x - nx*0.5, y - ny*0.5);
  ctx.lineTo(x + nx*0.5, y + ny*0.5);
  ctx.stroke();
  // đầu mũi tên
  ctx.beginPath();
  const h = 6;
  ctx.moveTo(x + nx*0.5, y + ny*0.5);
  ctx.lineTo(x + nx*0.5 - h*Math.cos(a - Math.PI/6), y + ny*0.5 - h*Math.sin(a - Math.PI/6));
  ctx.moveTo(x + nx*0.5, y + ny*0.5);
  ctx.lineTo(x + nx*0.5 - h*Math.cos(a + Math.PI/6), y + ny*0.5 - h*Math.sin(a + Math.PI/6));
  ctx.stroke();
}

// Vẽ đường sức bắt đầu từ seed, đi theo hướng B (Euler)
function drawStreamFrom(x0,y0, dir=+1){
  const maxStep = 900;
  let x=x0, y=y0;
  ctx.beginPath();
  ctx.moveTo(x,y);
  for(let i=0;i<maxStep;i++){
    const v = B(x,y);
    let mag = Math.hypot(v.bx, v.by);
    if(mag<1e-4) break;
    // bước đi tỉ lệ nghịch với cường độ để vẽ mịn
    const step = Math.min(8, 120/mag);
    x += dir * v.bx/mag * step;
    y += dir * v.by/mag * step;
    ctx.lineTo(x,y);
    if(x<0||y<0||x>cv.width||y>cv.height) break;
  }
  ctx.stroke();
}

// Vẽ một nam châm dạng hình chữ nhật, đánh dấu N–S
function drawMagnet(m){
  ctx.save();
  ctx.translate(m.x, m.y);
  ctx.rotate(m.angle);
  const w = m.length, h = 26;
  // thân
  ctx.fillStyle = '#ddd';
  ctx.strokeStyle = '#888';
  ctx.lineWidth = 1.5;
  ctx.beginPath();
  ctx.rect(-w/2, -h/2, w, h);
  ctx.fill(); ctx.stroke();
  // nửa N
  ctx.fillStyle = '#fce4ec';
  ctx.fillRect(0, -h/2, w/2, h);
  // nửa S
  ctx.fillStyle = '#e3f2fd';
  ctx.fillRect(-w/2, -h/2, w/2, h);
  // nhãn
  ctx.fillStyle = '#222';
  ctx.font = 'bold 12px system-ui';
  ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
  ctx.fillText('N', w/4, 0);
  ctx.fillText('S', -w/4, 0);
  // tay cầm xoay (đầu N)
  ctx.fillStyle = '#555';
  ctx.beginPath();
  ctx.arc(w/2, 0, 6, 0, 2*Math.PI);
  ctx.fill();
  ctx.restore();
}

let dragging = null; // {idx, mode:'move'|'rotate', dx, dy} 
cv.addEventListener('mousedown', e=>{
  const r = cv.getBoundingClientRect();
  const mx = e.clientX - r.left, my = e.clientY - r.top;
  // ưu tiên bắt tay cầm xoay
  for(let i=magnets.length-1; i>=0; i--){
    const m = magnets[i];
    const hx = m.x + Math.cos(m.angle)*m.length/2;
    const hy = m.y + Math.sin(m.angle)*m.length/2;
    if(Math.hypot(mx-hx, my-hy) < 10){
      dragging = {idx:i, mode:'rotate'};
      return;
    }
  }
  // bắt thân để kéo
  for(let i=magnets.length-1; i>=0; i--){
    const m = magnets[i];
    if(Math.hypot(mx-m.x, my-m.y) < 28){
      dragging = {idx:i, mode:'move', dx: mx - m.x, dy: my - m.y};
      return;
    }
  }
});
cv.addEventListener('mousemove', e=>{
  if(!dragging) return;
  const r = cv.getBoundingClientRect();
  const mx = e.clientX - r.left, my = e.clientY - r.top;
  const m = magnets[dragging.idx];
  if(dragging.mode==='move'){
    m.x = mx - dragging.dx; m.y = my - dragging.dy;
  }else{
    // xoay theo điểm đầu N
    const ang = Math.atan2(my - m.y, mx - m.x);
    let snap = ang;
    if(e.shiftKey){
      const step = Math.PI/12; // 15°
      snap = Math.round(ang/step)*step;
    }
    m.angle = snap;
  }
});
['mouseup','mouseleave'].forEach(ev=>cv.addEventListener(ev, ()=> dragging=null));

function draw(){
  ctx.clearRect(0,0,cv.width,cv.height);

  // Lưới mũi tên
  if(ui.showArrows.checked){
    ctx.save();
    ctx.strokeStyle = '#444';
    ctx.lineWidth = 1;
    const step = parseInt(ui.gridStep.value,10);
    const L = parseInt(ui.arrowScale.value,10);
    for(let x=step/2; x<cv.width; x+=step){
      for(let y=step/2; y<cv.height; y+=step){
        const v = B(x,y);
        const mag = Math.hypot(v.bx, v.by) + 1e-6;
        arrow(x,y, v.bx/mag, v.by/mag, L);
      }
    }
    ctx.restore();
  }

  // Đường sức – từ N → S
  if(ui.showStream.checked){
    ctx.save();
    ctx.strokeStyle = '#999';
    ctx.lineWidth = 1;
    for(const m of magnets){
      const ps = poles(m);
      const pN = ps[0]; // N
      // gieo hạt quanh cực N
      for(let i=0;i<streamSeedsPerMagnet;i++){
        const a = 2*Math.PI * i/streamSeedsPerMagnet;
        const r = 6;
        drawStreamFrom(pN.x + r*Math.cos(a), pN.y + r*Math.sin(a), +1);
      }
    }
    ctx.restore();
  }

  // Vẽ nam châm
  for(const m of magnets){ drawMagnet(m); }

  // “La bàn” tại con trỏ
  const mpos = mouse;
  if(mpos){
    const v = B(mpos.x, mpos.y);
    const mag = Math.hypot(v.bx, v.by) + 1e-6;
    const L = 50;
    ctx.save();
    ctx.translate(mpos.x, mpos.y);
    ctx.rotate(Math.atan2(v.by, v.bx));
    ctx.strokeStyle = '#d32f2f';
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.moveTo(-L*0.4, 0);
    ctx.lineTo(L*0.4, 0);
    ctx.stroke();
    ctx.fillStyle = '#d32f2f';
    ctx.beginPath(); ctx.arc(L*0.4,0,4,0,2*Math.PI); ctx.fill(); // đầu chỉ hướng B
    ctx.restore();
  }

  requestAnimationFrame(draw);
}

let mouse = null;
cv.addEventListener('mousemove', e=>{
  const r = cv.getBoundingClientRect();
  mouse = {x: e.clientX - r.left, y: e.clientY - r.top};
});
cv.addEventListener('mouseleave', ()=> mouse=null);

// UI events
ui.addMagnet.addEventListener('click', ()=>{
  magnets.push({x: 180 + Math.random()*640, y: 160 + Math.random()*320, angle: Math.random()*Math.PI*2, strength: 1.0, length: 100});
});
ui.reset.addEventListener('click', ()=> defaultMagnets());

draw();
</script>
</body>
</html>
